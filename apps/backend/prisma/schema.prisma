// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         UserRole @default(STAFF)
  jobTitle     String?
  phone        String?
  avatarUrl    String?
  isActive     Boolean  @default(true)

  // Email Signature Settings
  signatureEnabled Boolean @default(false)
  signatureStyle   String  @default("executive") // "executive" | "compact"
  signatureHtml    String? // Cached HTML signature - updated when settings change
  linkedinUrl      String?
  twitterUrl       String?
  instagramUrl     String?
  location         String? // City, Country
  officeAddress    String? // Full office address

  // Mail credentials (encrypted in production)
  mailPassword String?

  // Two-Factor Authentication
  totpSecret      String? // TOTP secret for authenticator apps
  totpEnabled     Boolean   @default(false)
  totpBackupCodes String[] // Hashed backup codes
  totpLastUsed    DateTime?

  // SSO / OAuth2 Integration
  ssoProvider    String?   // google, microsoft, keycloak, oidc
  ssoExternalId  String?   // External user ID from SSO provider
  lastSsoLogin   DateTime? // Last time user logged in via SSO

  // Email Hosting Integration
  primaryMailboxId   String? // Primary mailbox for this user
  mailboxes          Mailbox[] // All mailboxes linked to this user
  autoProvisionEmail Boolean   @default(true) // Auto-create mailbox on user creation

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdDocuments Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for SSO lookups
  @@index([ssoProvider, ssoExternalId])
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

// ==================== COMPANY / ORGANIZATION ====================

model Company {
  id      String  @id @default(uuid())
  name    String
  tagline String?
  email   String
  phone   String
  website String?

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  country      String
  postalCode   String?

  // Branding
  logoUrl        String?
  primaryColor   String  @default("#1E3A8A")
  secondaryColor String  @default("#F97316")

  // Business Info
  taxId          String?
  registrationNo String?
  bankName       String?
  bankAccount    String?
  bankBranch     String?

  users     User[]
  documents Document[]
  clients   Client[]
  templates Template[]
  assets    Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== CLIENTS (for invoices, quotations) ====================

model Client {
  id            String  @id @default(uuid())
  name          String
  email         String?
  phone         String?
  contactPerson String?

  addressLine1 String?
  addressLine2 String?
  city         String?
  country      String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  documents Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== DOCUMENTS ====================

model Document {
  id             String         @id @default(uuid())
  documentNumber String
  type           DocumentType
  status         DocumentStatus @default(DRAFT)

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime?

  // Financial
  subtotal  Decimal @default(0) @db.Decimal(12, 2)
  taxRate   Decimal @default(16) @db.Decimal(5, 2)
  taxAmount Decimal @default(0) @db.Decimal(12, 2)
  total     Decimal @default(0) @db.Decimal(12, 2)
  currency  String  @default("KES")

  // Content
  notes String?
  terms String?

  // Generated PDF
  pdfUrl String?

  // Relations
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  items DocumentItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DocumentType {
  INVOICE
  QUOTATION
  LETTERHEAD
  RECEIPT
}

enum DocumentStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model DocumentItem {
  id          String  @id @default(uuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)

  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ==================== TEMPLATES ====================

model Template {
  id          String       @id @default(uuid())
  name        String
  type        DocumentType
  description String?
  isDefault   Boolean      @default(false)

  // Template configuration (JSON)
  config Json?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== ASSETS (Logos, Generated PDFs, etc.) ====================

model Asset {
  id       String    @id @default(uuid())
  name     String
  type     AssetType
  mimeType String
  size     Int
  url      String

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
}

enum AssetType {
  LOGO
  DOCUMENT
  IMAGE
  OTHER
}

// ==================== EMAIL MESSAGES ====================

model Email {
  id        String      @id @default(uuid())
  messageId String      @unique
  folder    EmailFolder @default(INBOX)

  // Sender/Recipients
  fromName     String?
  fromAddress  String
  toAddresses  String[]
  ccAddresses  String[]
  bccAddresses String[]

  // Content
  subject  String
  textBody String?
  htmlBody String?
  snippet  String?

  // Full-text search vector (PostgreSQL tsvector)
  searchVector Unsupported("tsvector")?

  // Flags
  isRead         Boolean  @default(false)
  isStarred      Boolean  @default(false)
  hasAttachments Boolean  @default(false)
  labels         String[] // Custom labels/tags
  priority       String   @default("normal") // low, normal, high

  // Snooze
  snoozedUntil      DateTime? // When to unsnooze
  snoozedFromFolder String? // Original folder before snooze

  // Owner
  userId String

  // Timestamps
  sentAt      DateTime  @default(now())
  scheduledAt DateTime? // For scheduled sending
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  attachments EmailAttachment[]

  @@index([userId])
  @@index([folder])
  @@index([sentAt])
}

enum EmailFolder {
  INBOX
  SENT
  DRAFTS
  TRASH
  SPAM
  ARCHIVE
}

model EmailAttachment {
  id       String  @id @default(uuid())
  filename String
  mimeType String
  size     Int
  url      String?

  emailId String
  email   Email  @relation(fields: [emailId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// Outbox for delayed/scheduled sending (enables Undo Send)
model EmailOutbox {
  id String @id @default(uuid())

  // Sender/Recipients
  fromName     String?
  fromAddress  String
  toAddresses  String[]
  ccAddresses  String[]
  bccAddresses String[]

  // Content
  subject  String
  textBody String?
  htmlBody String?

  // Scheduling
  sendAt DateTime // When to actually send
  status OutboxStatus @default(PENDING)

  // If sent, reference to the Email record
  sentEmailId String?

  // Error handling
  errorMessage String?
  attempts     Int     @default(0)

  // Owner
  userId String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sendAt, status])
  @@index([userId])
}

enum OutboxStatus {
  PENDING // Waiting to be sent
  CANCELLED // User cancelled (undo)
  SENDING // Currently being sent
  SENT // Successfully sent
  FAILED // Failed to send
}

// ==================== EMAIL HOSTING ====================

model EmailDomain {
  id         String  @id @default(uuid())
  domain     String  @unique // e.g., "exoinafrica.com"
  isVerified Boolean @default(false)
  isActive   Boolean @default(true)

  // DNS Verification
  verificationCode   String? // Random code for DNS TXT verification
  verificationMethod String    @default("txt") // txt, cname
  verifiedAt         DateTime?

  // DKIM
  dkimSelector   String? // e.g., "mail"
  dkimPublicKey  String? // Public key for DNS TXT record
  dkimPrivateKey String? // Private key (encrypted)
  dkimVerified   Boolean @default(false)

  // SPF
  spfRecord   String? // Generated SPF record
  spfVerified Boolean @default(false)

  // DMARC
  dmarcPolicy   String  @default("none") // none, quarantine, reject
  dmarcRecord   String? // Generated DMARC record
  dmarcVerified Boolean @default(false)

  // MX
  mxVerified Boolean @default(false)

  // Catch-all
  catchAllEnabled   Boolean @default(false)
  catchAllMailboxId String?

  // Quotas
  maxMailboxes        Int @default(50)
  maxAliases          Int @default(100)
  totalStorageQuotaMb Int @default(51200) // 50GB default
  usedStorageMb       Int @default(0)

  // Relations
  companyId  String
  mailboxes  Mailbox[]
  aliases    EmailAlias[]
  dnsRecords DomainDNS[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([domain])
  @@index([companyId])
}

model Mailbox {
  id           String  @id @default(uuid())
  localPart    String // e.g., "info" for info@domain.com
  displayName  String? // Full display name
  passwordHash String // Hashed password for IMAP/SMTP

  // Quotas & Usage
  quotaMb       Int      @default(5120) // 5GB default per mailbox
  usedMb        Int      @default(0)
  maxSendPerDay Int      @default(500)
  sentToday     Int      @default(0)
  lastSentReset DateTime @default(now())

  // Settings
  isActive         Boolean   @default(true)
  isAdmin          Boolean   @default(false) // Domain admin
  autoReply        Boolean   @default(false)
  autoReplySubject String?
  autoReplyMessage String?
  autoReplyStart   DateTime?
  autoReplyEnd     DateTime?

  // Forwarding
  forwardingEnabled Boolean @default(false)
  forwardingAddress String?
  keepCopy          Boolean @default(true) // Keep copy when forwarding

  // Spam settings
  spamFilterLevel String @default("medium") // low, medium, high, aggressive
  spamAction      String @default("folder") // folder, delete, tag

  // Signature
  signatureHtml String?
  signatureText String?

  // Connected user (optional) - Link to app user
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Domain relation
  domainId String
  domain   EmailDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  // Aliases where this mailbox is the target
  targetAliases EmailAlias[] @relation("AliasTarget")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([localPart, domainId])
  @@index([domainId])
  @@index([userId])
}

model EmailAlias {
  id        String @id @default(uuid())
  localPart String // e.g., "support" for support@domain.com

  // Target can be a mailbox or external address
  targetMailboxId String?
  targetMailbox   Mailbox? @relation("AliasTarget", fields: [targetMailboxId], references: [id], onDelete: SetNull)
  externalTarget  String? // External email address if not a mailbox

  isActive Boolean @default(true)

  // Domain relation
  domainId String
  domain   EmailDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([localPart, domainId])
  @@index([domainId])
}

model DomainDNS {
  id          String        @id @default(uuid())
  recordType  DNSRecordType
  name        String // e.g., "@", "mail", "_dmarc"
  value       String // Record value
  priority    Int? // For MX records
  ttl         Int           @default(3600)
  description String? // Human-readable description

  isRequired    Boolean   @default(true)
  isVerified    Boolean   @default(false)
  lastCheckedAt DateTime?

  domainId String
  domain   EmailDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([domainId])
}

enum DNSRecordType {
  MX
  TXT
  CNAME
  A
  AAAA
  SRV
}

model EmailLog {
  id        String  @id @default(uuid())
  messageId String?
  direction String // inbound, outbound

  fromAddress String
  toAddress   String
  subject     String?

  status       EmailLogStatus
  errorMessage String?

  // Size & metadata
  sizeBytes      Int?
  hasAttachments Boolean @default(false)

  // SMTP details
  smtpCode     Int?
  smtpResponse String?

  // Spam scoring
  spamScore  Float?
  spamAction String?

  // Timing
  processedAt DateTime  @default(now())
  deliveredAt DateTime?

  // Domain reference
  domainId  String?
  mailboxId String?

  createdAt DateTime @default(now())

  @@index([domainId])
  @@index([mailboxId])
  @@index([createdAt])
  @@index([status])
}

enum EmailLogStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  BOUNCED
  REJECTED
  SPAM
  FAILED
}

model EmailQuarantined {
  id        String @id @default(uuid())
  messageId String

  fromAddress String
  toAddress   String
  subject     String?

  reason    String // spam, virus, policy
  spamScore Float?

  // Original message stored as reference
  rawHeaders  String?
  previewText String?

  // Actions
  releasedAt DateTime?
  releasedBy String?
  deletedAt  DateTime?

  domainId String

  createdAt DateTime @default(now())
  expiresAt DateTime // Auto-delete after X days

  @@index([domainId])
  @@index([createdAt])
}

// ==================== EMAIL TEMPLATES ====================

model EmailTemplate {
  id       String                @id @default(uuid())
  name     String
  subject  String
  htmlBody String?
  textBody String?
  category EmailTemplateCategory @default(GENERAL)

  // Placeholders info (for UI hints)
  placeholders String[] // e.g., ["{{name}}", "{{company}}"]

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Sharing
  isShared Boolean @default(false) // Shared with team

  // Owner
  userId    String
  companyId String? // If shared, belongs to company

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([companyId])
  @@index([category])
}

enum EmailTemplateCategory {
  GENERAL
  SALES
  SUPPORT
  MARKETING
  HR
  FINANCE
  FOLLOW_UP
  MEETING
  INTRODUCTION
  THANK_YOU
}

// ==================== VACATION RESPONDER ====================

model VacationResponder {
  id String @id @default(uuid())

  // Date range
  startDate DateTime
  endDate   DateTime

  // Message
  subject String @default("Out of Office")
  message String

  // Settings
  isActive     Boolean @default(true)
  onlyContacts Boolean @default(false) // Only respond to known contacts
  onlyOnce     Boolean @default(true) // Only respond once per sender

  // Excluded domains (won't auto-reply to these)
  excludedDomains String[]

  // Track who we've responded to
  respondedTo String[] // Email addresses already responded to

  // Owner
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isActive, startDate, endDate])
}

// ==================== EMAIL TRACKING ====================

model EmailTracking {
  id         String @id @default(uuid())
  trackingId String @unique // UUID used in tracking pixel/links

  // Reference to sent email
  emailId  String?
  outboxId String?

  // Email details
  subject        String
  recipientEmail String

  // Tracking events
  opens  EmailTrackingEvent[]
  clicks EmailLinkClick[]

  // Summary stats
  openCount     Int       @default(0)
  clickCount    Int       @default(0)
  firstOpenedAt DateTime?
  lastOpenedAt  DateTime?

  // User who sent the email
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([trackingId])
  @@index([createdAt])
}

model EmailTrackingEvent {
  id         String        @id @default(uuid())
  trackingId String
  tracking   EmailTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  eventType String // 'open', 'click'

  // Device/location info
  ipAddress String?
  userAgent String?
  device    String? // desktop, mobile, tablet
  browser   String?
  country   String?
  city      String?

  createdAt DateTime @default(now())

  @@index([trackingId])
}

model EmailLinkClick {
  id         String        @id @default(uuid())
  trackingId String
  tracking   EmailTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  originalUrl String // Original link URL
  clickCount  Int    @default(1)

  // Device info for last click
  ipAddress String?
  userAgent String?

  firstClickedAt DateTime @default(now())
  lastClickedAt  DateTime @default(now())

  @@unique([trackingId, originalUrl])
  @@index([trackingId])
}

// ==================== MAIL MERGE ====================

model MailMerge {
  id   String @id @default(uuid())
  name String

  // Template
  subject  String
  htmlBody String?
  textBody String?

  // Recipients from CSV
  recipientCount Int  @default(0)
  recipients     Json // Array of recipient objects with placeholders

  // Status
  status      MailMergeStatus @default(DRAFT)
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Stats
  sentCount   Int @default(0)
  failedCount Int @default(0)

  // Owner
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum MailMergeStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== EMAIL HOSTING SETTINGS ====================

model EmailHostingSettings {
  id String @id @default(uuid())

  // Default domain for auto-provisioning
  defaultDomainId String?

  // Email format settings
  emailFormat String @default("firstname.lastname") // firstname.lastname, firstnamelastname, firstname_lastname, first.last

  // Auto-provisioning settings
  autoProvisionEnabled Boolean @default(true) // Auto-create mailbox on user creation
  defaultQuotaMb       Int     @default(5120) // Default quota for new mailboxes
  defaultMaxSendPerDay Int     @default(500) // Default send limit per day

  // Notification settings
  notifyOnProvision    Boolean @default(true) // Notify user when mailbox is created
  welcomeEmailTemplate String? // Template for welcome email

  // Security defaults
  requireStrongPassword Boolean @default(true)
  minPasswordLength     Int     @default(8)

  // Company relation
  companyId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ==================== MAILBOX AUDIT LOG ====================

model MailboxAuditLog {
  id String @id @default(uuid())

  // What action was performed
  action MailboxAuditAction

  // Target mailbox/user
  mailboxId String?
  userId    String?
  domainId  String?

  // Who performed the action
  performedById String?

  // Details
  details   Json? // Additional context (old values, new values, etc.)
  ipAddress String?
  userAgent String?

  // Status
  success      Boolean @default(true)
  errorMessage String?

  // Company context
  companyId String

  createdAt DateTime @default(now())

  @@index([mailboxId])
  @@index([userId])
  @@index([companyId])
  @@index([action])
  @@index([createdAt])
}

enum MailboxAuditAction {
  MAILBOX_CREATED
  MAILBOX_UPDATED
  MAILBOX_DELETED
  MAILBOX_LINKED_TO_USER
  MAILBOX_UNLINKED_FROM_USER
  MAILBOX_PASSWORD_CHANGED
  MAILBOX_QUOTA_CHANGED
  MAILBOX_ACTIVATED
  MAILBOX_DEACTIVATED
  USER_PROVISIONED_MAILBOX
  BULK_IMPORT_STARTED
  BULK_IMPORT_COMPLETED
  DOMAIN_SETTINGS_CHANGED
}
